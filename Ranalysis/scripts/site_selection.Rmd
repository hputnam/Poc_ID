---
title: "Untitled"
author: "HM Putnam"
date: "10/1/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#Load Libraries
```{r}
#https://stackoverflow.com/questions/63653396/specific-number-of-points-within-each-polygon-of-a-shape-in-r
library(sf)
library(ggplot2)
library(ggmap)
library(sf)
library(ggsn)
library(tidyverse)
library(patchwork)
```

#Read in shp files
```{r}

#geomorphic shape file extracted from Allen Coral Atlas
Moorea <- st_read("/Users/hputnam/Downloads/Moorea_polygons/geomorphic.shp")
#polygons outlined from around the LTER site GPS points
LTER1 <- st_read("/Users/hputnam/Downloads/Moorea_polygons/LTER1_small_boundary.shp")
LTER2 <- st_read("/Users/hputnam/Downloads/Moorea_polygons/LTER2_small_boundary.shp")
LTER3 <- st_read("/Users/hputnam/Downloads/Moorea_polygons/LTER3_small_boundary.shp")
LTER4 <- st_read("/Users/hputnam/Downloads/Moorea_polygons/LTER4_small_boundary.shp")
LTER5 <- st_read("/Users/hputnam/Downloads/Moorea_polygons/LTER5_small_boundary.shp")
LTER6 <- st_read("/Users/hputnam/Downloads/Moorea_polygons/LTER6_small_boundary.shp")

#north shore potential site polygons extracted from Allen Atlas
NS1 <- st_read("/Users/hputnam/Downloads/Moorea_polygons/NS1_boundary.shp")
NS2 <- st_read("/Users/hputnam/Downloads/Moorea_polygons/NS2_boundary.shp")
NS3 <- st_read("/Users/hputnam/Downloads/Moorea_polygons/NS3_boundary.shp")
NS4 <- st_read("/Users/hputnam/Downloads/Moorea_polygons/NS4_boundary.shp")
NS5 <- st_read("/Users/hputnam/Downloads/Moorea_polygons/NS5_boundary.shp")

#polygons made available by the MCR
MCR <- st_read("/Users/hputnam/Downloads/Moorea_polygons/LTER_boundary.shp")

#Moorea PGEM site polygons extracted from Allen Atlas using the PGEM map
PGEM1 <- st_read("/Users/hputnam/Downloads/Moorea_polygons/PGEM1_boundary.shp")
PGEM2 <- st_read("/Users/hputnam/Downloads/Moorea_polygons/PGEM2_boundary.shp")
PGEM3 <- st_read("/Users/hputnam/Downloads/Moorea_polygons/PGEM3_boundary.shp")
PGEM4 <- st_read("/Users/hputnam/Downloads/Moorea_polygons/PGEM4_boundary.shp")
PGEM5 <- st_read("/Users/hputnam/Downloads/Moorea_polygons/PGEM5_boundary.shp")
PGEM6 <- st_read("/Users/hputnam/Downloads/Moorea_polygons/PGEM6_boundary.shp")
PGEM7 <- st_read("/Users/hputnam/Downloads/Moorea_polygons/PGEM7_boundary.shp")
PGEM8 <- st_read("/Users/hputnam/Downloads/Moorea_polygons/PGEM8_boundary.shp")
```

#substract PGEM and LTER sites from available sites
```{r}
#substract the PGEM from the available sites
#https://gis.stackexchange.com/questions/109639/reverse-clipping-erasing-in-r
# find the 'difference', i.e. reverse of st_intersection
NS1.diff <- st_difference(NS1,PGEM1)
NS2.diff <- NS2
NS3.diff <- st_difference(NS3,PGEM2)
NS4.diff <- NS4
NS5.diff <- st_difference(NS5,PGEM3)

#substract the LTER from the available sites
#https://gis.stackexchange.com/questions/109639/reverse-clipping-erasing-in-r
# find the 'difference', i.e. reverse of st_intersection
NS1.diff <- NS1.diff
NS2.diff <- NS2.diff
NS3.diff <- st_difference(NS3,LTER1)
NS4.diff <- st_difference(NS4,LTER2)
NS5.diff <- NS5.diff

```

#generate random points wihtin the available polygons
```{r}
# st_sample needs a vector telling it how many samples for each site polygon
#  here we're using # for each polygon
set.seed(1234)
#NS1.samples <- st_sample(NS2.diff, 1, type = "random")
#NS2.samples <- st_sample(NS2.diff, 20, type = "random")
NS3.samples <- st_sample(NS3.diff, 1, type = "random")
NS4.samples <- st_sample(NS4.diff, 1, type = "random")
NS5.samples <- st_sample(NS5.diff, 1, type = "random")


#create a buffer space around the points so they must be Xm or Xkm away from each other
#https://stackoverflow.com/questions/64391369/how-to-specify-a-minimum-distance-between-points-in-sfst-sample
#Random points

NS2.samples <- st_sample(NS2.diff, size = 20, type="random")
NS2.samples <- st_sf(NS2.samples)

original <- NS2.samples # for comparison later :)


i <- 1 # iterator start

buffer_size <- 1800 # minimal distance to be enforced (in units of your CRS)

repeat( {
  #  create buffer around i-th point
  buffer <- st_buffer(NS2.samples[i,], buffer_size ) 
  
  offending <- NS2.samples %>%  # start with the intersection of master points... 
    st_intersects(buffer, sparse = F) # ... and the buffer, as a vector
  
  # i-th point is not really offending - it is the origin (not to be excluded)
  offending[i] <- FALSE
  
  # if there are any offending points left - re-assign the master points, 
  # with the offending ones excluded / this is the main pruning part :)
  NS2.samples <- NS2.samples[!offending,] 
  
  if ( i >= nrow(NS2.samples)) {
    # the end was reached; no more points to process
    break 
  } else {
    # rinse & repeat
    i <- i + 1 
  }
  
} )


plot(original, pch = 4, col = "grey25") # result of the st_sample()

plot(NS2.samples, pch = 4, col = "red", add = T) # pruned points





```

#plot Moorea, PGEM, LTER, Available, and selected sites
```{r}
MooreaSitemap <- ggplot() + geom_sf(data = Moorea) +
  #plot extracted LTER polygons
  geom_sf(data = LTER1, aes(fill="MCR")) +
  geom_sf(data = LTER2, aes(fill="MCR")) +
  geom_sf(data = LTER3, aes(fill="MCR")) +
  geom_sf(data = LTER4, aes(fill="MCR")) +
  geom_sf(data = LTER5, aes(fill="MCR")) +
  geom_sf(data = LTER6, aes(fill="MCR")) +
  #plot extracted PGEM polygons
  geom_sf(data = PGEM1, aes(fill="PGEM")) +
  geom_sf(data = PGEM2, aes(fill="PGEM")) +
  geom_sf(data = PGEM3, aes(fill="PGEM")) +
  geom_sf(data = PGEM4, aes(fill="PGEM")) +
  geom_sf(data = PGEM5, aes(fill="PGEM")) +
  geom_sf(data = PGEM6, aes(fill="PGEM")) +
  geom_sf(data = PGEM7, aes(fill="PGEM")) +
  geom_sf(data = PGEM8, aes(fill="PGEM")) +
  #plot extracted available Sites polygons
  geom_sf(data = NS1.diff, aes(fill="Available")) +
  geom_sf(data = NS2.diff, aes(fill="Available")) +
  geom_sf(data = NS3.diff, aes(fill="Available")) +
  geom_sf(data = NS4.diff, aes(fill="Available")) +
  geom_sf(data = NS5.diff, aes(fill="Available")) +
  #plot randomly selected site points
  #geom_sf(data = NS1.samples, aes(color = "Sites")) +
  geom_sf(data = NS2.samples, aes(color = "Sites")) +
  geom_sf(data = NS3.samples, aes(color = "Sites")) +
  geom_sf(data = NS4.samples, aes(color = "Sites")) +
  geom_sf(data = NS5.samples, aes(color = "Sites")) +
  scale_fill_manual(name='Areas',
                     breaks=c('MCR', 'PGEM', 'Sites', 'Available'),
                     values=c('MCR'='yellow', 'PGEM'='black',
                              'Available'='green','Sites'='red')) +
  theme_bw()

pdf("/Users/hputnam/Downloads/Moorea_polygons/transect_sites.pdf")
MooreaSitemap
dev.off()
```
#Write out randomly selected site coordinates
```{r}

st_write(NS2.samples, layer_options = "GEOMETRY=AS_XY", "/Users/hputnam/Downloads/Moorea_polygons/sites/transect.site.coords2.csv")
st_write(NS3.samples, layer_options = "GEOMETRY=AS_XY", append = TRUE, "/Users/hputnam/Downloads/Moorea_polygons/sites/transect.site.coords3.csv")
st_write(NS4.samples, layer_options = "GEOMETRY=AS_XY", "/Users/hputnam/Downloads/Moorea_polygons/sites/transect.site.coords4.csv")
st_write(NS5.samples, layer_options = "GEOMETRY=AS_XY", "/Users/hputnam/Downloads/Moorea_polygons/sites/transect.site.coords5.csv")

sites <- list.files(path='/Users/hputnam/Downloads/Moorea_polygons/sites/') %>%
  str_subset("\\.csv$")  %>%
  lapply(read_csv) %>% 
  bind_rows

colnames(sites) <-c("long", "lat")
sites$site.name <- c(paste0("site"," ", rep(1:nrow(sites),each = 1)))

write.csv(sites,"/Users/hputnam/Downloads/Moorea_polygons/sites/transect.site.coords.csv")


```
