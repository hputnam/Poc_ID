---
title: "biomass.Rmd"
author: "HM Putnam, AS Huffmyer"
date: "10/26/2021"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)

## install packages if you dont already have them
if (!require("tidyverse")) install.packages("tidyverse")
if (!require("plotrix")) install.packages("plotrix")

# load packages
library(tidyverse)
library(plotrix)
library(patchwork)

```

```{r }
#Read in biomass data
Data.May <- read.csv("data/May_biomass_data.csv")
Data.May$Timepoint <- "May"
Data.Dec <- read.csv("data/Dec_biomass_data.csv")
Data.Dec$Timepoint <- "Dec"
Data <- rbind(Data.May, Data.Dec)
Data <- Data %>% filter(partner !="PBS Blank")

# calculated mass per ml
#different volumes for sym and host 
sym <- 5
host <- 4

#Load tissue homogenate volume
homog_vol <- read.csv("data/homogenate_vols.csv", header=TRUE)

# Load Surface area data
sa <- read.csv("output/TPC_Phys.surface.area.calc.csv")

# Coral sample metadata
metadata <- read_csv("data/metadata_POC_TPC.csv")

# Join homogenate volumes and surface area with sample metadata
metadata <- full_join(metadata, homog_vol) %>%
  full_join(sa)

#Standardize for volume input
Data <- Data %>%
  mutate(dry.pan.mass.g.ml = case_when(partner=="Sym" ~ dry.pan.mass.g/sym, partner=="Host" ~dry.pan.mass.g/host),
         burnt.pan.mass.g.ml = case_when(partner=="Sym" ~ burnt.pan.mass.g/sym, partner=="Host" ~burnt.pan.mass.g/host))

# Standardize for the total homogenate volume
Data <- left_join(Data, homog_vol)  %>%
  mutate(dry.pan.mass.g.vol.corr = dry.pan.mass.g.ml*homog_vol_ml, 
         burnt.pan.mass.g.vol.corr = burnt.pan.mass.g.ml*homog_vol_ml)


# Calculate Dry Biomass
dw <- left_join(Data, metadata) %>%
  mutate(dry.bioimass.g = (dry.pan.mass.g.vol.corr - initial.mass.g),
         DW.mg.cm2 = ((dry.bioimass.g)*1000) / surface.area.cm2)


# Calculate AFDW
afdw <- left_join(Data, metadata) %>%
  mutate(dry.bioimass.g = (dry.pan.mass.g.vol.corr - burnt.pan.mass.g.vol.corr),
         AFDW.mg.cm2 = ((dry.bioimass.g)*1000) / surface.area.cm2)


```

Output biomass data to .csv.  

```{r}
dw<-dw %>% 
  group_by(fragment_ID, partner, Timepoint)%>%
  summarise(DW.mg.cm2=mean(DW.mg.cm2))%>%
  left_join(.,metadata)%>% #add metadata back into file
  select(fragment_ID, Timepoint, partner, Morphology, DW.mg.cm2) 

afdw<-afdw %>%
  group_by(fragment_ID, partner, Timepoint)%>%
  summarise(AFDW.mg.cm2=mean(AFDW.mg.cm2))%>%
  left_join(.,metadata)%>% #add metadata back into file
  select(fragment_ID, Timepoint, partner, Morphology, AFDW.mg.cm2)
  
output<-left_join(afdw,dw)%>%
  write_csv(path = "output/TPC_Phys_biomass.csv")
```

```{r}
#summarize Dry Biomass mean and sem by site, species, and partner and plot
# Plot all data points with mean ± se
dw_plot <- dw %>%
  ggplot(aes(x = Morphology, y = DW.mg.cm2, color = Morphology, shape=Timepoint, group = Timepoint)) +
  labs(x = "", y = expression("Dry Biomass mg"~cm^{-2})) +
  geom_jitter(width = 0.3) +                                            # Plot all points
  stat_summary(fun.data = mean_cl_normal, fun.args = list(mult = 1),    # Plot standard error
               geom = "errorbar", width = 0.2) +
  scale_shape_manual(values=c(Dec=16,May=17))+
  stat_summary(fun = mean, geom = "point", size=3) +           # Plot mean
  scale_color_manual(name="Morphology", values=c("orange","black", "cyan"))+
  theme_bw(base_size = 12)+
  theme(legend.position='none')+
  facet_wrap("partner")


```

```{r}

# Plot all data points with mean ± se
afdw_plot <- afdw %>%
  ggplot(aes(x = Morphology, y = AFDW.mg.cm2, color = Morphology, shape=Timepoint, group = Timepoint)) +
  labs(x = "", y = expression("AFDW mg"~cm^{-2})) +
  geom_jitter(width = 0.3) +                                            # Plot all points
  stat_summary(fun.data = mean_cl_normal, fun.args = list(mult = 1),    # Plot standard error
               geom = "errorbar", width = 0.2) +
  scale_shape_manual(values=c(Dec=16,May=17))+
  stat_summary(fun = mean, geom = "point", size=3) +           # Plot mean
  scale_color_manual(name="Morphology", values=c("orange","black", "cyan"))+
  theme_bw(base_size = 12)+
  facet_wrap("partner")

```


```{r}
 (dw_plot+afdw_plot) 
  ggsave("output/Poc_TPC_Biomass.pdf", plot = last_plot(), width = 12, height = 6)
```
